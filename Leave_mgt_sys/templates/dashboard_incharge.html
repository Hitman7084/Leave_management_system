{% extends "base.html" %}
{% load static %}
{% block title %}Incharge Dashboard{% endblock %}

{% block sidebar %}
<ul class="nav flex-column">
    <li class="nav-item">
        <a class="nav-link" href="#" id="home-link">Home</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#">Profile</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" id="leave-history-link">Leave History</a>
    </li>
    <li class="nav-item">
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-link nav-link">Logout</button>
        </form>
    </li>
</ul>
{% endblock %}

{% block content %}
<div class="main-content">
    <h2 class="inchrg-header">Leave Requests</h2>
    <table class="inchrg-table">
        <tr>
            <th>Student</th>
            <th>Message</th>
            <th>Attachment</th>
            <th>Submitted At</th>
            <th>Action</th>  
        </tr>
        {% for leave in leave_requests %}
        <tr>
            <td>{{ leave.student.username }}</td>
            <td>
                <div class="message-container">
                    <span id="msg-preview-{{ leave.id }}">
                        {{ leave.message|slice:":50" }}{% if leave.message|length > 50 %}...{% endif %}
                    </span>
                    
                    <span id="msg-full-{{ leave.id }}" style="display: none;">
                        {{ leave.message }}
                    </span>
            
                    {% if leave.message|length > 50 %}
                    <button type="button" class="btn-toggle" onclick="toggleMessage({{ leave.id }})">
                        Show More
                    </button>
                    {% endif %}
                </div>
            </td>
            <td>
                {% if leave.attachment %}
                <a href="{{ leave.attachment.url }}" target="_blank">View File</a>
                {% else %}
                No Attachment
                {% endif %}
            </td>
            <td>{{ leave.submitted_at }}</td>
            <td>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="leave_id" value="{{ leave.id }}">
                    
                    <button type="submit" name="action" value="approve" class="btn-success">Forward to Dean</button>
                    
                    <button type="button" onclick="showRejectInput({{ leave.id }})" class="btn-danger">Reject</button>
                    
                    <div id="reject-form-{{ leave.id }}" style="display: none; margin-top: 5px;">
                        <input type="text" name="rejection_reason" placeholder="Rejection Reason" required>
                        <button type="submit" name="action" value="reject" class="btn-danger">Confirm Reject</button>
                    </div>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<script>
function showRejectInput(leaveId) {
    document.getElementById("reject-form-" + leaveId).style.display = "block";
}

function toggleMessage(leaveId) {
    let preview = document.getElementById("msg-preview-" + leaveId);
    let fullMsg = document.getElementById("msg-full-" + leaveId);
    let btn = document.querySelector(`button[onclick="toggleMessage(${leaveId})"]`);

    if (fullMsg.style.display === "none") {
        fullMsg.style.display = "inline";
        preview.style.display = "none";
        btn.textContent = "Show Less";
    } else {
        fullMsg.style.display = "none";
        preview.style.display = "inline";
        btn.textContent = "Show More";
    }
}
</script>

{% endblock %}
